#!/usr/bin/env python3
"""
Script to fix srcset parsing errors in collection.html
The main issues are:
1. Malformed srcset URLs with query parameters
2. Invalid descriptors in srcset attributes
"""

import re
import sys
from pathlib import Path

def fix_srcset_attributes(html_content):
    """Fix malformed srcset attributes that are causing parsing errors"""
    
    # Pattern to match srcset attributes with malformed URLs
    # This matches srcset attributes that contain query parameters which are invalid
    srcset_pattern = r'srcset="([^"]*?384w\?url=[^"]*?)"'
    
    def fix_srcset(match):
        srcset_value = match.group(1)
        
        # Extract the base image path (before the query parameters)
        base_path_match = re.search(r'(_next/[^?]+\.png)', srcset_value)
        if base_path_match:
            base_path = base_path_match.group(1)
            # Replace the malformed srcset with just the base path and proper descriptor
            return f'srcset="{base_path} 384w"'
        
        return match.group(0)  # Return unchanged if we can't fix it
    
    # Apply the fix
    fixed_content = re.sub(srcset_pattern, fix_srcset, html_content)
    
    return fixed_content

def remove_auto_refresh_meta(html_content):
    """Remove any meta refresh tags that might cause continuous updates"""
    
    # Remove meta refresh tags
    meta_refresh_pattern = r'<meta[^>]*http-equiv=["\']refresh["\'][^>]*>'
    html_content = re.sub(meta_refresh_pattern, '', html_content, flags=re.IGNORECASE)
    
    return html_content

def fix_script_tags(html_content):
    """Fix any problematic script tags that might cause continuous updates"""
    
    # Look for script tags that might be causing issues
    # This is a conservative approach - we'll just ensure proper closing
    
    # Fix unclosed script tags
    script_pattern = r'<script([^>]*)>([^<]*)'
    
    def fix_script(match):
        script_attrs = match.group(1)
        script_content = match.group(2)
        
        # If the script content doesn't end with </script>, add it
        if not script_content.strip().endswith('</script>'):
            return f'<script{script_attrs}>{script_content}</script>'
        
        return match.group(0)
    
    html_content = re.sub(script_pattern, fix_script, html_content)
    
    return html_content

def main():
    input_file = "collection.html"
    output_file = "collection_fixed.html"
    
    if not Path(input_file).exists():
        print(f"Error: {input_file} not found!")
        sys.exit(1)
    
    print(f"Reading {input_file}...")
    with open(input_file, 'r', encoding='utf-8') as f:
        content = f.read()
    
    print("Fixing srcset attributes...")
    content = fix_srcset_attributes(content)
    
    print("Removing auto-refresh meta tags...")
    content = remove_auto_refresh_meta(content)
    
    print("Fixing script tags...")
    content = fix_script_tags(content)
    
    print(f"Writing fixed content to {output_file}...")
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(content)
    
    print("Done! The fixed file has been saved as collection_fixed.html")
    print("You can now replace the original file with the fixed version.")

if __name__ == "__main__":
    main() 




